# âœ… T3.2 - Nightly Directus Export Configuration

**Task**: Configure automatic nightly export from Directus  
**Status**: ğŸŸ¡ IN PROGRESS  
**Duration**: ~20-30 minutes  
**Difficulty**: Easy  

---

## ğŸ¯ Objective

Setup GitHub Actions to automatically export Directus data to JSON every night at 2 AM UTC.

**Result**: `data/directus-export.json` updates automatically with latest content

---

## ğŸ“‹ Prerequisites

Before starting, ensure:

- [x] GitHub repository created
- [x] LOT 3 T3.1 workflows created (export.yml exists)
- [x] Directus running (docker-compose up -d)
- [x] Directus admin credentials available (email & password)
- [x] Git repository connected to GitHub

**Status**: âœ… Ready to proceed

---

## ğŸ“ Step 1: Get Directus Credentials

### From Your Environment

Check your `.env.directus` or `.env` file:

```bash
# View Directus configuration
cat .env.directus | grep -E "DIRECTUS_|ADMIN"
```

**You need**:
- `DIRECTUS_URL` - Your Directus API URL (e.g., `http://localhost:8055`)
- `DIRECTUS_EMAIL` - Admin email (e.g., `pauld.75020@gmail.com`)
- `DIRECTUS_PASSWORD` - Admin password

### Example Values

```
DIRECTUS_URL       = http://localhost:8055
DIRECTUS_EMAIL     = pauld.75020@gmail.com
DIRECTUS_PASSWORD  = YourSecurePassword123!
```

**âš ï¸ IMPORTANT**: Keep password secure! Only add to GitHub Secrets, never commit to git.

---

## ğŸ” Step 2: Add GitHub Secrets

### How to Add Secrets

1. **Go to GitHub**:
   - Repository â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**

2. **Click "New repository secret"**

3. **Add first secret**:
   ```
   Name:  DIRECTUS_URL
   Value: http://localhost:8055
   ```
   Click **Add secret**

4. **Add second secret**:
   ```
   Name:  DIRECTUS_EMAIL
   Value: pauld.75020@gmail.com
   ```
   Click **Add secret**

5. **Add third secret**:
   ```
   Name:  DIRECTUS_PASSWORD
   Value: [Your admin password]
   ```
   Click **Add secret**

### Verification

After adding all 3 secrets, you should see:

```
DIRECTUS_EMAIL        â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (hidden)
DIRECTUS_PASSWORD     â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (hidden)
DIRECTUS_URL          â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (hidden)
```

**Note**: Secrets are encrypted and hidden - you won't see their values again.

---

## ğŸ§ª Step 3: Test Export Workflow Manually

### Trigger Export

1. **Go to GitHub**:
   - Repository â†’ **Actions** tab

2. **Select workflow**:
   - Click: **"Nightly Directus Export"**

3. **Run workflow**:
   - Click: **"Run workflow"** dropdown
   - Click: **"Run workflow"** button
   - Wait for confirmation

### Watch Execution

1. **See workflow running**:
   - Yellow indicator: "In progress"
   - Green checkmark: "Success"
   - Red X: "Failed"

2. **Click on run** to see details

3. **Expand each step** to see logs

### Expected Output

```
âœ“ Checkout code
âœ“ Setup Node.js
âœ“ Install dependencies
âœ“ Export data from Directus
  âœ… Authenticated
  âœ… Collections exported: 6
  âœ… Records exported: 50+
âœ“ Check for changes
âœ“ Commit changes
  âœ… Created commit: chore: update directus export
```

---

## âœ… Step 4: Verify Export Success

### Check GitHub Workflow

1. **Go to Actions tab**
2. **Click latest run** of "Nightly Directus Export"
3. **See status**:
   - âœ… All green = SUCCESS
   - âŒ Any red = FAILED

### Check Exported File

1. **Go to Code tab**
2. **Navigate to**: `data/directus-export.json`
3. **View file** - should see JSON structure:
   ```json
   {
     "consoles": [...],
     "guides": [...],
     "accessories": [...],
     "videos": [...],
     "images": [...],
     "affiliate_config": [...]
   }
   ```

### Check Git Commit

1. **Go to Code tab**
2. **Click "Commits"**
3. **See new commit**: "chore: update directus export [timestamp]"
4. **Click commit** to see changes

---

## ğŸ”„ Step 5: Schedule Automatic Runs

### Export Runs

The export workflow is configured to run automatically:

**Schedule**: Daily at **2:00 AM UTC**

### Convert to Your Timezone

- **EST** (New York): 9 PM previous day
- **CST** (Chicago): 8 PM previous day  
- **MST** (Denver): 7 PM previous day
- **PST** (California): 6 PM previous day
- **GMT** (London): Same day
- **CET** (Europe): 3 AM (early morning)

### Adjust Schedule (if needed)

Edit: `.github/workflows/export.yml`

Find this line:
```yaml
cron: '0 2 * * *'
```

Change `0 2` to your preferred time:
- `0 7 * * *` = 7 AM UTC
- `0 12 * * *` = 12 PM UTC (noon)
- `0 18 * * *` = 6 PM UTC

Save and push to GitHub - new schedule takes effect immediately.

---

## ğŸ“Š Workflow Details

### What Happens Each Run

```
1. Checkout latest code
2. Setup Node.js environment
3. Install npm dependencies
4. Authenticate to Directus
5. Export all collections to JSON
6. Check for changes in JSON
7. If changed:
   - Commit file to git
   - Push to GitHub
8. If no changes:
   - Skip commit (no changes needed)
9. Report success/failure
```

### Export Script

Uses: `scripts/export-directus-json.js`

**What it does**:
- Authenticates using email/password from secrets
- Fetches all collections (consoles, guides, etc.)
- Writes to `data/directus-export.json`
- Includes metadata (timestamps, versions)

**Time**: ~10-30 seconds typically

---

## ğŸ”— Integration with Build

### After Export Succeeds

1. **Build Workflow** triggered automatically
2. **Eleventy builds** using exported JSON
3. **Creates** `_site/` static HTML files
4. **Tests** run (4/4 should pass)
5. **Ready** for deployment

**Full pipeline**: Export (2 min) â†’ Build (3 min) â†’ Ready!

---

## âš ï¸ Troubleshooting

### Export Fails: "Invalid credentials"

**Problem**: Workflow can't authenticate to Directus

**Solutions**:

1. **Check secrets exist**:
   - GitHub â†’ Settings â†’ Secrets
   - Verify all 3 secrets present

2. **Verify credentials**:
   ```bash
   # Test locally first
   npm run directus:export
   ```
   Check for errors

3. **Reset password if needed**:
   ```bash
   # SSH to server
   docker exec jvo-directus node /directus/cli/index.js users passwd
   ```

4. **Check Directus running**:
   ```bash
   docker-compose ps
   # Should show directus-directus-1 RUNNING
   ```

5. **Verify Directus URL**:
   - `DIRECTUS_URL` must match where Directus runs
   - Local: `http://localhost:8055`
   - Remote: `https://directus.example.com`

### Export Fails: "No changes"

**Expected behavior** - not a failure!
- If data hasn't changed, no commit made
- Saves git history from noise
- Next push will still trigger build

### Workflow Not Running at Scheduled Time

**Check**:
1. GitHub Secrets properly set? âœ…
2. Workflow file syntax correct? âœ…
3. Check Actions tab for errors
4. Manually trigger to test

**Note**: GitHub schedules are in UTC. If you set `0 2 * * *`, it runs at 2 AM UTC regardless of your timezone.

### JSON File Not Updating

**Verify**:
1. Click into workflow run
2. Check step logs:
   - "Export data from Directus"
   - "Check for changes"
3. If both green but file not updated:
   - Check file name: `data/directus-export.json`
   - Check git push succeeded
   - Refresh browser cache (Ctrl+F5)

---

## âœ… Success Checklist

After completing T3.2, verify:

- [ ] All 3 GitHub Secrets added (DIRECTUS_URL, EMAIL, PASSWORD)
- [ ] Export workflow manual trigger tested
- [ ] Workflow completed with âœ… status
- [ ] `data/directus-export.json` file exists and updated
- [ ] Latest commit shows "chore: update directus export"
- [ ] Build workflow triggered automatically (optional, not required)
- [ ] All steps show green checkmarks
- [ ] No error messages in logs

**If all checked**: âœ… T3.2 COMPLETE

---

## ğŸ“ˆ What to Expect

### First Run

When you manually trigger export:
- **1-2 minutes**: Workflow executes
- **Result**: JSON file updated with all 6 collections
- **Git commit**: Auto-created
- **Next**: Build workflow should trigger

### Nightly Runs

Every day at 2 AM UTC:
- Workflow runs automatically
- Updates `data/directus-export.json`
- Commits if changes found
- You see result in GitHub Actions

### Content Updates

When you edit content in Directus:
1. Edit in admin UI
2. Click "Save" in Directus
3. Wait until next 2 AM UTC
4. Workflow exports latest version
5. Build creates new HTML
6. Site shows updated content

**Faster alternative**: Manually trigger export anytime!

---

## ğŸš€ Manual Export Anytime

Don't want to wait until 2 AM?

1. **Go to GitHub â†’ Actions**
2. **Click "Nightly Directus Export"**
3. **Click "Run workflow"**
4. **Wait 2 minutes**
5. **Site updated!** âœ…

---

## ğŸ“Š Monitoring

### View All Export Runs

1. **GitHub â†’ Actions**
2. **Click "Nightly Directus Export"**
3. **See all runs** with dates, times, status

### View Export Logs

1. **Click a run**
2. **See all steps** with logs
3. **Expand any step** for detailed output
4. **Download logs** if needed

### Export History

All exports visible in GitHub Actions:
- Date/time of run
- Duration
- Status (success/failure)
- Changes made

---

## ğŸ’¡ How It Works

### Nightly Cycle

```
Day 1, 2:00 AM UTC
â”œâ”€ Export triggered
â”œâ”€ Data exported from Directus
â”œâ”€ Committed to git
â”œâ”€ Build workflow triggered
â””â”€ _site/ updated

Day 2, 2:00 AM UTC
â”œâ”€ Export triggered again
â”œâ”€ Latest data exported
â”œâ”€ If changed: commit
â”œâ”€ Build triggered
â””â”€ _site/ updated
```

### Benefits

âœ… **Automatic**: No manual steps  
âœ… **Scheduled**: Runs every night  
âœ… **Reliable**: Monitored and logged  
âœ… **Fast**: ~2 minutes total  
âœ… **Reversible**: Git history tracks all changes  
âœ… **Flexible**: Can trigger manually anytime  

---

## ğŸ”„ Next Steps

### Immediate (Now)

- [x] Add GitHub Secrets
- [x] Test export workflow
- [x] Verify JSON file updated

### Next Session (T3.3)

- [ ] Setup production server
- [ ] Add DEPLOY_* secrets
- [ ] Configure deployment

### Long-term

- [ ] Monitor nightly exports
- [ ] Content creation in Directus
- [ ] Monitor automatic builds
- [ ] Prepare for T3.3 deployment

---

## ğŸ“ Quick Reference

| Task | Steps |
|------|-------|
| Add secret | GitHub Settings â†’ Secrets â†’ New secret |
| Test export | Actions â†’ Export â†’ Run workflow |
| Check status | Actions â†’ Latest run â†’ See âœ…/âŒ |
| View exported file | Code â†’ data/directus-export.json |
| Check commits | Code â†’ Commits â†’ See latest |
| Adjust schedule | Edit .github/workflows/export.yml |
| Trigger manually | Actions â†’ Export â†’ Run workflow |

---

## âœ¨ T3.2 Summary

**What This Task Does**:
- Automatic nightly Directus data export
- JSON file updated daily at 2 AM UTC
- Git commits track all changes
- Build triggered on export completion
- Manual trigger available anytime

**Time Required**:
- Add secrets: 10 minutes
- Test export: 5 minutes
- Verify success: 5 minutes
- **Total: 20 minutes**

**Result**: âœ… Fully automated export pipeline

---

## ğŸ¯ Status

```
T3.2 - Nightly Export Configuration
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Add GitHub Secrets        âœ… or â³ (do this now)
Test Export Workflow      âœ… or â³ (do this after secrets)
Verify JSON Updated       âœ… or â³ (check after test)
Verify Git Commit         âœ… or â³ (check git history)

Status: Ready to configure
```

---

**Estimated Time**: 20 minutes to complete  
**Next Task**: T3.3 - Build & Deploy Setup  
**Recommendation**: Complete now, proceed to T3.3 after

ğŸš€ **Let's setup automatic exports!**
