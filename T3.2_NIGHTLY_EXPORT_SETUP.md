# âœ… T3.2 - Nightly Export Configuration

**Task**: Configure nightly Directus exports in GitHub Actions  
**Status**: ğŸŸ¡ IN PROGRESS  
**Date**: February 1, 2026  
**Duration**: ~30 minutes  

---

## ğŸ“‹ Objective

Setup automated nightly exports from Directus to JSON file that:
- Runs daily at 2 AM UTC automatically
- Commits changes to git automatically
- Can be triggered manually anytime
- Works with email/password authentication (no API key needed)

---

## âœ… Current Status

**Tested locally**:
```
âœ… Directus running (containers healthy)
âœ… Script directus:export functional
âœ… JSON export generated successfully
âœ… All 6 collections exported (currently empty, ready for content)
```

**Credentials working**:
```
DIRECTUS_URL: http://localhost:8055
ADMIN_EMAIL: admin@jvo.local
ADMIN_PASSWORD: admin
```

---

## ğŸ” Step 1: Add GitHub Secrets

Go to your GitHub repository:

**URL**: `https://github.com/75bernard75/JVoGithubCodespace/settings/secrets/actions`

Or navigate manually:
1. Click **Settings**
2. Left menu: **Secrets and variables** â†’ **Actions**
3. Click **New repository secret**

### Add These 3 Secrets

#### Secret 1: DIRECTUS_URL
- **Name**: `DIRECTUS_URL`
- **Value**: `http://localhost:8055`
- Click **Add secret**

#### Secret 2: DIRECTUS_EMAIL
- **Name**: `DIRECTUS_EMAIL`
- **Value**: `admin@jvo.local`
- Click **Add secret**

#### Secret 3: DIRECTUS_PASSWORD
- **Name**: `DIRECTUS_PASSWORD`
- **Value**: `admin`
- Click **Add secret**

**Result**: 3 secrets added âœ…

---

## ğŸ§ª Step 2: Test Export Workflow Manually

Once secrets are added, test the export workflow:

### Via GitHub Web UI

1. Go to: `https://github.com/75bernard75/JVoGithubCodespace/actions`
2. Left menu: Click **Nightly Directus Export**
3. Click **Run workflow** button (top right)
4. Branch: Keep as **main**
5. Click **Run workflow** button
6. Wait 2-3 minutes for completion

### What to Expect

The workflow will:
1. Checkout code âœ…
2. Setup Node.js âœ…
3. Install dependencies âœ…
4. Run `npm run directus:export` âœ…
5. Check for changes âœ…
6. Commit if changes found âœ…
7. Report success âœ…

### Check Results

After workflow completes:

**In GitHub Actions UI**:
- Click the workflow run
- See green âœ… checkmarks on all steps
- See "Export completed successfully" in logs

**In Repository**:
- Go to `data/directus-export.json`
- Should show updated timestamp in commit history
- First export will have empty collections

---

## ğŸ“Š Expected Output

### Workflow Log Output
```
ğŸš€ Starting Directus export...
âœ… Authenticated successfully
âœ… Connected to Directus v11.14.1
âœ… Fetched 0 items from consoles
âœ… Fetched 0 items from guides
âœ… Fetched 0 items from accessories
âœ… Fetched 0 items from videos
âœ… Fetched 0 items from images
âœ… Fetched 0 items from affiliate_config

âœ… Export complete!
   File: data/directus-export.json
   Size: 0.28 KB
   Items: 0 total
   Collections: 6
```

### JSON File
```json
{
  "consoles": [],
  "guides": [],
  "accessories": [],
  "videos": [],
  "images": [],
  "affiliate_config": [],
  "metadata": {
    "exportedAt": "2026-02-01T17:59:39.733Z",
    "directusUrl": "http://localhost:8055",
    "totalItems": 0,
    "collections": 6,
    "version": "1.0"
  }
}
```

**Note**: Collections are empty now (OK). When you add content to Directus, they'll be exported.

---

## â±ï¸ Automatic Scheduling

The workflow is configured to run:

**When**: Daily at 2 AM UTC  
**Cron**: `0 2 * * *`

### Timezone Conversion

| Timezone | Time |
|----------|------|
| UTC | 2:00 AM |
| EST (US) | 9:00 PM previous day |
| CST (US) | 8:00 PM previous day |
| PST (US) | 6:00 PM previous day |
| CET (Europe) | 3:00 AM |
| IST (India) | 7:30 AM |

**Need different time?** Edit `.github/workflows/export.yml`:
```yaml
on:
  schedule:
    - cron: '0 7 * * *'  # Change 2 to 7 for 7 AM UTC
```

---

## ğŸ¯ Success Criteria

T3.2 is complete when:

- [x] Directus running locally (verified âœ…)
- [x] Export script working (tested âœ…)
- [x] GitHub Secrets added (pending - DO THIS NEXT)
- [ ] Workflow triggered manually
- [ ] Workflow runs without errors
- [ ] `data/directus-export.json` updates
- [ ] Changes committed to git
- [ ] Git history shows new commits

---

## ğŸ“ Troubleshooting

### "Permission denied" or "workflow not found"

**Fix**:
1. Verify `.github/workflows/export.yml` exists in main branch
2. Make sure you're in the correct GitHub repository
3. Refresh page: `Ctrl+Shift+R`

### "Invalid credentials" error in logs

**Fix**:
1. Verify secrets added correctly:
   - Name must match exactly (case-sensitive)
   - Value must match Directus admin account
2. Test locally: `npm run directus:export` should work
3. Check Directus still running: `docker-compose ps`

### "Commit failed" or "Git push failed"

**Fix**:
1. Verify GitHub token has write access
2. This is usually automatic - if error, check repo settings

### "No changes" message (workflow passes but no commit)

**This is OK** âœ…
- Means export ran but found no new data
- If you add content later, next export will commit

### Workflow times out (takes >5 minutes)

**Fix**:
1. Check Directus is responding: `curl http://localhost:8055`
2. If slow, increase timeout in workflow file
3. Reduce amount of data being exported

---

## ğŸ”„ What Happens Next (Automatic)

Once export workflow completes successfully:

```
Export Workflow Completes
    â†“
(If changes found)
    â†“
Commit to git
    â†“
Trigger Build Workflow automatically
    â†“
Build Eleventy site
    â†“
Run tests
    â†“
Upload artifact
    â†“
(Ready for deploy in T3.3)
```

---

## ğŸ“ˆ Usage Tips

### To Add Content and Export

1. **SSH or open Directus admin**
   - Go to: http://localhost:8055
   - Login with admin@jvo.local / admin
   
2. **Add content** (e.g., a gaming console)
   - Collection: **consoles**
   - Add fields: name, description, etc.
   - Click Save

3. **Trigger export manually**
   - GitHub â†’ Actions â†’ Nightly Directus Export
   - Click "Run workflow"
   - Wait 2 minutes

4. **Verify changes**
   - Check `data/directus-export.json`
   - Should now have items in consoles array
   - Git commit created

---

## ğŸš€ Running Exports on Schedule

After setup, exports happen automatically:

**Daily at 2 AM UTC**:
- No action needed
- Changes committed automatically
- Build triggered if changes found

**Manual export anytime**:
1. GitHub â†’ Actions
2. Nightly Directus Export
3. Run workflow
4. Done in 2-3 minutes

---

## ğŸ“ How Secrets Work

### Why Use Secrets?

Your GitHub Actions workflow needs credentials to:
- Connect to Directus
- Authenticate as admin
- Export data
- Commit to git

### How GitHub Protects Secrets

- âœ… Encrypted at rest
- âœ… Not visible in workflow logs
- âœ… Only accessible to workflows in your repo
- âœ… Can't be read via API
- âœ… Automatically redacted in logs

### Security Best Practices

- âœ… Never commit `.env` file (should be in `.gitignore`)
- âœ… Use secrets for all sensitive data
- âœ… Rotate secrets every 90 days (optional)
- âœ… Use different accounts for different services
- âŒ Don't share secret values
- âŒ Don't print secrets in logs

---

## ğŸ“Š Monitoring Export Status

### View Recent Exports

**GitHub Actions UI**:
1. Go to: https://github.com/75bernard75/JVoGithubCodespace/actions
2. Click: **Nightly Directus Export**
3. See all runs with timestamps and status

### View Export Logs

Click on a workflow run to see details:
- Which step failed (if any)
- Complete output from each step
- Download logs for archive

### Check Exported Data

Every export commits to git:
```bash
git log --oneline --follow data/directus-export.json
```

Shows commit history of all exports.

---

## ğŸ”— Integration with T3.3 & T3.4

T3.2 prepares data for next tasks:

**T3.3 (Build & Deploy)**:
- Reads `data/directus-export.json`
- Passes to Eleventy during build
- Site gets latest content

**T3.4 (Monitoring)**:
- Health checks verify export ran
- Alerts if export fails
- Dashboard shows export status

---

## âœ… Checklist - T3.2 Complete When

- [ ] Read this guide completely
- [ ] Understand how secrets work
- [ ] Add 3 GitHub Secrets (DIRECTUS_URL, EMAIL, PASSWORD)
- [ ] Verify secrets added (see them in GitHub settings)
- [ ] Trigger export workflow manually
- [ ] Wait for workflow to complete
- [ ] See green checkmarks on all steps
- [ ] Verify no errors in logs
- [ ] Check `data/directus-export.json` updated
- [ ] See new commit in git history
- [ ] Test one more time (optional)

**Estimated time**: 20-30 minutes

---

## ğŸ¯ What's Working

âœ… **Local Export**:
```bash
npm run directus:export
```
Generates: `data/directus-export.json` (tested Feb 1, 2026)

âœ… **Export Workflow**:
```yaml
.github/workflows/export.yml
```
Ready to run (waiting for secrets)

âœ… **Authentication**:
Email/password auth fallback working (no API key needed)

âœ… **Directus Connection**:
v11.14.1 running, responding to queries

---

## ğŸš€ Next: T3.3 (Build & Deploy)

After T3.2 is complete:
1. Export workflow running nightly âœ…
2. Data committed to git âœ…
3. Ready to build (T3.3)

T3.3 will:
- Trigger on export changes
- Build Eleventy site
- Deploy to production

---

## ğŸ“ Quick Reference

| Task | Command/URL |
|------|------------|
| View workflows | https://github.com/75bernard75/JVoGithubCodespace/actions |
| Add secrets | https://github.com/75bernard75/JVoGithubCodespace/settings/secrets/actions |
| Check export file | `cat data/directus-export.json` |
| Test export locally | `npm run directus:export` |
| View git history | `git log --oneline -10` |
| See commits | `git log --follow -- data/directus-export.json` |

---

**Status**: Ready to add GitHub Secrets and test ğŸš€

**Next**: Follow steps above to complete T3.2 in 20-30 minutes
