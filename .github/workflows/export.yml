name: Nightly Directus Export

on:
  # DISABLED: Was causing email spam - run manually with workflow_dispatch if needed
  # schedule:
  #   - cron: '0 2 * * *'
  
  # Manual trigger for testing
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    name: Export Directus Data

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸš€ Export data from Directus
        run: npm run directus:export
        env:
          DIRECTUS_URL: ${{ secrets.DIRECTUS_URL }}
          DIRECTUS_EMAIL: ${{ secrets.DIRECTUS_EMAIL }}
          DIRECTUS_PASSWORD: ${{ secrets.DIRECTUS_PASSWORD }}

      - name: ğŸ“Š Check for changes
        id: verify
        run: |
          if git diff --quiet data/directus-export.json; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ No changes in export"
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "âœ“ Export has changes"
          fi

      - name: ğŸ”§ Setup git
        if: steps.verify.outputs.no_changes == 'false'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ğŸ’¾ Commit changes
        if: steps.verify.outputs.no_changes == 'false'
        run: |
          git add data/directus-export.json
          git commit -m "chore: update directus export $(date +'%Y-%m-%d %H:%M:%S')"
          git push

      - name: ğŸ“¢ Notify success
        if: success()
        run: echo "âœ… Export completed successfully"

      - name: âš ï¸ Notify failure
        if: failure()
        run: echo "âŒ Export failed - check logs"
